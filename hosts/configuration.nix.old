# Edit this configuration file to define what should be installed on
# your system. Help is available in the configuration.nix(5) man page, on
# https://search.nixos.org/options and in the NixOS manual (`nixos-help`).

{ config, lib, pkgs, home-manager, ... }:

{
  imports =
    [ ./hardware-configuration.nix
    ] ++ 
    (import ./desktop-env) ++
    (import ./services);

  boot.loader = {
    systemd-boot = {
      enable = true;
      configurationLimit = 6;
    };
    timeout = 2;
  };  
  boot.loader.efi.canTouchEfiVariables = true;

  
  hardware.nvidia.open = true;

  hardware.bluetooth = {
    enable = true;
    powerOnBoot = true;
  };

  services.blueman.enable = true;
    security.polkit.extraConfig = ''
    polkit.addRule(function(action, subject) {
      if (
        subject.isInGroup("users")
          && (
            action.id == "org.freedesktop.login1.reboot" ||
            action.id == "org.freedesktop.login1.reboot-multiple-sessions" ||
            action.id == "org.freedesktop.login1.power-off" ||
            action.id == "org.freedesktop.login1.power-off-multiple-sessions"
          )
        )
      {
        return polkit.Result.YES;
      }
    });
  '';

  services.pipewire = {
    enable = true;
    audio.enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    wireplumber.enable = true;
    pulse.enable = true;
    jack.enable = true;
  };

  networking = {
    hostName = "nixos";
    networkmanager.enable = true;  # Easiest to use and most distros use this by default.
    
    interfaces = {
      enp4s0 = {
        wakeOnLan = {
          enable = true;
          policy = ["magic"];
        };
      };	  
    };
  };
  networking.firewall.extraCommands = ''iptables -t raw -A OUTPUT -p udp -m udp --dport 137 -j CT --helper netbios-ns'';

  services.xserver = {
    enable = true;
    xkb.layout = "de";
    windowManager.i3.enable = true;
    displayManager = {
      lightdm.enable = true;
    };

    videoDrivers = [ "nvidia" ];

    # monitor configuration
    xrandrHeads = [
      "DP-5"
      {
        output = "HMDI-0";
      	primary = true;
      }
    ];
  };
  services.displayManager = {
    defaultSession ="none+i3";
#   autoLogin.user = "siigs";
#   autoLogin.enable = true;
  };

  services.playerctld.enable = true;

  # List packages installed in system profile. To search, run:
  # $ nix search wget
  environment.systemPackages = with pkgs; [
    drawio
    pandoc
    texlivePackages.collection-latexrecommended
    xclip
    fd
    texliveTeTeX
    discord
    vlc
    firefox
    qjackctl
    wget
    rofi
    alsa-utils
    arandr

    nodejs_22
    python313
    go
    R

    spotify
  ];

  system.stateVersion = "24.05"; # Did you read the comment?

}

